<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milestone Escrow Demo</title>
</head>
<body>
    <h1>Milestone Escrow - Demo Frontend</h1>
    <button id="connectButton">Connect Metamask</button>
    <p id="accountDisplay">Not connected</p>

    <h3>Create New Job</h3>
    <form id="jobForm">
        <label>Freelancer Address : </label><br>
        <input type="text" id="freelancer" placeholder="0x..."><br><br>

        <label>Milestones &lpar;comma separated&rpar; : </label><br>
        <input type="text" id="milestones" placeholder="e.g., 100,200,300"><br><br>

        <button type="submit">Create Job</button>
    </form>

    <p id="jobStatus"></p>

    <h3>View Job Details</h3>
    <form id="viewJobForm">
         <label>Job ID:</label><br>
         <input type="number" id="jobId" placeholder="Enter Job ID"><br><br>
          <button type="submit">View Job</button>
    </form>

    <div id="jobDetails"></div>

    <h3>Submit Work</h3>
    <form id="submitWorkForm">
        <label>Job ID:</label><br>
        <input type="number" id="submitJobId" placeholder="Job ID"><br><br>

        <label>Milestone ID:</label><br>
        <input type="number" id="submitMilestoneId" placeholder="Milestone ID"><br><br>

        <button type="submit">Submit Work</button>
    </form>

    <p id="submitStatus"></p>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const connectButton = document.getElementById('connectButton');
        const accountDisplay = document.getElementById('accountDisplay');

        let provider;
        let signer;
        let contract;

        const CONTRACT_ADDRESS = '0x316bb4bcd134F9227c2aBEC79F365D771A7BF3aa';

        // Load ABI from abi.json dynamically
        async function loadContract() {
            const response = await fetch('abi.json');
            const abi = await response.json();
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
        }


        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    accountDisplay.innerText = `Connected: ${accounts[0]}`;
                    await loadContract();
                    console.log('Contract loaded:', contract);
                } catch (err) {
                    console.error('Connection failed:', err);
                }
            } else {
                accountDisplay.innerText = 'MetaMask not installed';
            }
        });


        const jobForm = document.getElementById('jobForm');
        const freelancerInput = document.getElementById('freelancer');
        const milestonesInput = document.getElementById('milestones');
        const jobStatus = document.getElementById('jobStatus');

        jobForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const freelancer = freelancerInput.value.trim();
            const milestoneStr = milestonesInput.value.trim();

            if (!freelancer || !milestoneStr) {
                jobStatus.innerText = 'Please fill in all fields';
                return;
            }

            const milestoneAmounts = milestoneStr.split(',').map(v => ethers.BigNumber.from(v.trim()));
            const totalValue = milestoneAmounts.reduce((sum, v) => sum.add(v), ethers.BigNumber.from(0));

            try {
                const tx = await contract.createJob(freelancer, milestoneAmounts, {
                    value: totalValue
                });
                jobStatus.innerText = 'Transaction submitted...';

                await tx.wait(); // Wait for confirmation
                jobStatus.innerText = 'Job created successfully!';
            } catch (err) {
                console.error(err);
                jobStatus.innerText = 'Transaction failed.';
            }
        })

        const viewJobForm = document.getElementById('viewJobForm');
        const jobIdInput = document.getElementById('jobId');
        const jobDetails = document.getElementById('jobDetails');

        viewJobForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const jobId = jobIdInput.value;
            if (!jobId) {
                jobDetails.innerText = 'Please enter a job ID';
                return;
            }

            try {
                const job = await contract.jobs(jobId);

                jobDetails.innerHTML = `
                    <strong>Client:</strong> ${job.client}<br>
                    <strong>Freelancer:</strong> ${job.freelancer}<br>
                    <strong>Total Amount:</strong> ${job.totalAmount.toString()} wei<br>
                    <strong>Status:</strong> ${job.status} <em>(0=Active, 1=Completed, 2=Cancelled)</em><br>
                    <strong>Milestones:</strong> ${job.milestoneCount}
                `;
            } catch (err) {
                console.error(err);
                jobDetails.innerText = 'Error fetching job details';
            }
        });

    </script>
</body>
</html>